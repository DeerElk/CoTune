# Отчет по тестированию backend в Docker-сети

Дата: 2026-02-17  
Область: только `go-backend`, проверка в локальной Docker-сети (`docker compose --scale peer=10`) с внешним bootstrap VPS.

## Что было сделано

- Поднята сеть из 10 peer-контейнеров в `server` режиме.
- Проверены control endpoint'ы:  
  `/status`, `/peers`, `/providers`, `/addTrack`, `/search`, `/replicate`, `/disconnect`, `/connect`, `/shutdown`, `/metrics`.
- Прогнаны сценарии: `mass-add`, `mass-search`, `convergence`, `churn`, `latency`.
- Использовались bootstrap-адреса VPS:
  - `/ip4/84.201.172.91/udp/4001/quic-v1/p2p/12D3KooWN9yd5yKtJkAitShdz6CSD71cJ666JFEargFMWX6SaanY`
  - `/ip4/84.201.172.91/tcp/4001/p2p/12D3KooWN9yd5yKtJkAitShdz6CSD71cJ666JFEargFMWX6SaanY`

## Исправленные проблемы

- Исправлен ложный успех `mass-add` в `docker/test_controller.sh`:
  - раньше скрипт мог писать `added ...`, даже если запрос не сработал;
  - теперь считается реальный успешный результат (`added X/Y`).
- В Docker-образ добавлен `ffmpeg`, чтобы `addTrack` реально обрабатывал аудио.
- Тест-контроллер теперь генерирует валидный WAV в контейнере, а не использует не-аудио файл.
- Исправлена ошибка локального поиска:
  - токены больше не склеиваются в одну строку;
  - поиск идет по каждому токену отдельно.
- Добавлена синхронизация CTR -> поисковый индекс:
  - после вычисления CTID трек сразу попадает в локальный search index;
  - токены трека публикуются в DHT сразу после успешного CTR.
- Добавлен периодический retry bootstrap в DHT-сервисе, если узел остался без WAN-DHT.
- В `test_controller.sh` добавлен авто-mesh для тестов (`AUTO_MESH=1` по умолчанию):
  - peer'ы автоматически соединяются в локальной Docker-сети;
  - это убирает флапы тестов, когда внешний bootstrap временно недоступен.
- В `test_controller.sh` исправлен выбор контейнеров:
  - теперь берутся только `running` контейнеры (`docker compose ps --status running`).

## Что сейчас точно работает

- Сборка и запуск сети из 10 peer-контейнеров (healthcheck проходит).
- Control API на всех активных контейнерах.
- `/status` возвращает рабочие метрики узла (`peer_id`, `routing_table_size`, `provider_count`, `connected_peers`).
- `/metrics` отдает Prometheus-метрики.
- `/connect` и `/disconnect` работают.
- `mass-add` стабильно дает `1/1` на peer (для валидных WAV).
- `mass-search load_track` теперь возвращает ненулевые результаты (в тестах: `search hits=2..3` на peer).
- `churn` и `latency` сценарии выполняются.

## Что работает частично / с оговорками

- Внешний bootstrap VPS остается не всегда стабильным для каждого контейнера в момент старта  
  (в логах могут быть `Bootstrap failed` / `No bootstrap peers reachable`).
- Для стабильного интеграционного теста сети добавлен авто-mesh в контроллере.
- По `convergence` часть peer'ов может иметь `routing_table_size=0`, но при этом быть соединенной с остальными (`connected_peers` высокое значение) за счет mesh-связности.

## Что не покрыто этим Docker-отчетом

- Полный streaming QoS (длительное воспроизведение, автоматическое переключение провайдера под нагрузкой).
- Полная проверка репликации по `ctid` в end-to-end сценарии с валидацией скачанного файла.
- Android-специфика (живучесть daemon вне lifecycle Flutter, энергопотребление, фоновые ограничения ОС).
- Масштабные требования ТЗ (1k / 100M узлов), строгие измерения O(log N) на больших топологиях.
- Serverless bootstrap flow через QR / код подключения в мобильном UI.

## Итог относительно ТЗ

- Критичные проблемы тестовой сети backend, мешавшие проверке функций (`search=0`, нестабильный `mass-add`, flaky сценарии), исправлены.
- Для Docker-интеграции backend сейчас можно проводить повторяемую проверку основных функций.
- Полное соответствие всем пунктам ТЗ еще требует дополнительных нагрузочных и Android-специфичных прогонов.

